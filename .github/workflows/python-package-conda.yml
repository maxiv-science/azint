name: Python Package using Conda (Compatible Build)

on: [push]

jobs:
  build-linux-oldglibc:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Prepare output folder
      run: mkdir -p ${{ github.workspace }}/conda-bld
      
    - name: Build conda package inside Rocky Linux 8 container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workdir \
          -w /workdir \
          rockylinux:8 /bin/bash -c "
            dnf install -y epel-release && \
            dnf install -y git wget bzip2 make gcc gcc-c++ python3 python3-pip && \
            python3 -m pip install --upgrade pip setuptools wheel && \
            python3 -m pip install setuptools_scm && \
            wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
            bash miniconda.sh -b -p /opt/conda && \
            rm miniconda.sh && \
            export PATH=/opt/conda/bin:$PATH && \
            conda update -n base -c defaults conda -y && \
            conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
            conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r && \
            conda install -y conda-build boa mamba git && \
            export SETUPTOOLS_SCM_PRETEND_VERSION=\$(python3 -m setuptools_scm) && \
            echo \"Version: \$SETUPTOOLS_SCM_PRETEND_VERSION\" && \
            conda mambabuild conda-recipe --output-folder=/workdir/conda-bld
          "

    - name: Upload built Linux packages
      uses: actions/upload-artifact@v4
      with:
        name: package-linux-oldglibc
        path: ${{ github.workspace }}/conda-bld/**/azint*.bz2

  build-win:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: ilammy/msvc-dev-cmd@v1
    - uses: conda-incubator/setup-miniconda@v2
      with:
        miniforge-version: latest
    - name: Install conda-build and dependencies
      shell: pwsh
      run: conda install conda-build setuptools_scm boa git
    - name: Build package
      shell: pwsh
      run: |
        $env:SETUPTOOLS_SCM_PRETEND_VERSION = $(python -m setuptools_scm)
        Write-Host "Version: $env:SETUPTOOLS_SCM_PRETEND_VERSION"
        conda mambabuild "$env:GITHUB_WORKSPACE/conda-recipe" --output-folder="$env:GITHUB_WORKSPACE"
    - uses: actions/upload-artifact@v4
      with:
        name: package-win
        path: ${{ github.workspace }}/**/azint*.bz2

  build-mac:
    runs-on: macos-13
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: latest
    - name: Install conda-build and dependencies
      shell: bash -l {0}
      run: conda install conda-build setuptools_scm boa git
    - name: Build package
      shell: bash -l {0}
      run: |
        export SETUPTOOLS_SCM_PRETEND_VERSION=$(python -m setuptools_scm)
        echo "Version: $SETUPTOOLS_SCM_PRETEND_VERSION"
        conda mambabuild $GITHUB_WORKSPACE/conda-recipe --output-folder=$GITHUB_WORKSPACE
    - uses: actions/upload-artifact@v4
      with:
        name: package-mac
        path: ${{ github.workspace }}/**/azint*.bz2
